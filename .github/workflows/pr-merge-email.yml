name: Notify PR Merge

on:
  pull_request:
    types:
      - closed

jobs:
  send-email:
    # Only run if the PR was merged AND the head branch matches the release format (e.g., 'release/v1.2.3')
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/v')
    # Best practice: define explicit permissions for the job
    permissions:
      contents: read # Only need to read repo contents, no write needed
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: >
            [${{ github.repository }}] PR #${{ github.event.pull_request.number }}: "${{ github.event.pull_request.title }}" has been released
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: ${{ secrets.NOTIFY_EMAIL_FROM }}
          body: |
            The pull request #${{ github.event.pull_request.number }} ("${{ github.event.pull_request.title }}") from branch '${{ github.event.pull_request.head.ref }}' has been merged into '${{ github.event.pull_request.base.ref }}'. 
            Repository: ${{ github.repository }}
            Merged by: ${{ github.event.pull_request.merged_by.login }}
            URL: ${{ github.event.pull_request.html_url }}
            Merge Commit: ${{ github.event.pull_request.merge_commit_sha || github.sha }}
            Driver Documentation available at https://github.com/${{ github.repository }}/tree/${{ github.event.pull_request.merge_commit_sha }}/kernel/docs (manual download required).
            video: https://drive.google.com/file/d/1_47SzWyVgFcC9ekai40h0w_B3ducMeWN/view?usp=drive_link
